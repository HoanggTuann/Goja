<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoJa - ·ª®ng D·ª•ng T·ª´ V·ª±ng Ti·∫øng Nh·∫≠t</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-indigo-50 font-sans">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebaseAppModules = {
            initializeApp, getAuth, signInWithCustomToken, signInAnonymously,
            getFirestore, doc, getDoc, runTransaction, setLogLevel
        };
        setLogLevel('Debug');
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        const { 
            initializeApp, getAuth, signInWithCustomToken, signInAnonymously, 
            getFirestore, doc, getDoc, runTransaction 
        } = window.firebaseAppModules;

        const QUIZ_DATA = [
            { word: "ÊôØËâ≤ („Åë„Åó„Åç)", options: ["Th·ªùi ti·∫øt", "C·∫£nh s·∫Øc", "L·ªãch s·ª≠", "√Çm nh·∫°c"], answer: "C·∫£nh s·∫Øc" },
            { word: "ÂÖ•Èô¢„Åô„Çã („Å´„ÇÖ„ÅÜ„ÅÑ„Çì„Åô„Çã)", options: ["T·ªët nghi·ªáp", "Nh·∫≠p vi·ªán", "Xu·∫•t c·∫£nh", "V√†o c√¥ng ty"], answer: "Nh·∫≠p vi·ªán" },
            { word: "Âç±„Å™„ÅÑ („ÅÇ„Å∂„Å™„ÅÑ)", options: ["Nhanh ch√≥ng", "Nguy hi·ªÉm", "D·ªÖ d√†ng", "Quan tr·ªçng"], answer: "Nguy hi·ªÉm" },
            { word: "Â∞ÜÊù• („Åó„Çá„ÅÜ„Çâ„ÅÑ)", options: ["Qu√° kh·ª©", "Hi·ªán t·∫°i", "T∆∞∆°ng lai", "B√¢y gi·ªù"], answer: "T∆∞∆°ng lai" },
            { word: "‰∫§ÈÄö („Åì„ÅÜ„Å§„ÅÜ)", options: ["C√¥ng vi·ªác", "Giao th√¥ng", "Th·ªùi ti·∫øt", "S·ª©c kh·ªèe"], answer: "Giao th√¥ng" },
            { word: "ÁµåÈ®ì („Åë„ÅÑ„Åë„Çì)", options: ["L√Ω thuy·∫øt", "Ki·∫øn th·ª©c", "Kinh nghi·ªám", "H·ªçc v·∫•n"], answer: "Kinh nghi·ªám" }
        ];

        const useGoJaScoreAndAuth = () => {
            const [db, setDb] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [highScore, setHighScore] = useState(0);
            const [isLoading, setIsLoading] = useState(true);
            const appId = useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'goja-app', []);

            useEffect(() => {
                const authenticateAndInit = async () => {
                    try {
                        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                        if (!Object.keys(firebaseConfig).length) throw new Error("Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh Firebase.");
                        const app = initializeApp(firebaseConfig);
                        const authInstance = getAuth(app);
                        const dbInstance = getFirestore(app);
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(authInstance, __initial_auth_token);
                        } else {
                            await signInAnonymously(authInstance);
                        }
                        const currentUserId = authInstance.currentUser?.uid || crypto.randomUUID();
                        setUserId(currentUserId);
                        setDb(dbInstance);
                        setIsAuthReady(true);
                    } catch (error) {
                        console.error("L·ªói x√°c th·ª±c:", error.message);
                        setIsAuthReady(true); 
                    } finally {
                        setIsLoading(false);
                    }
                };
                authenticateAndInit();
            }, []);

            const loadHighScore = useCallback(async () => {
                if (!db || !userId) return;
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/scores`, 'goja_high_score');
                try {
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) setHighScore(docSnap.data().score);
                } catch (error) { console.error(error); }
            }, [db, userId, appId]);

            useEffect(() => {
                if (isAuthReady && userId && db) loadHighScore();
            }, [isAuthReady, userId, db, loadHighScore]);

            const saveHighScore = useCallback(async (newScore) => {
                if (!db || !userId) return;
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/scores`, 'goja_high_score');
                try {
                    await runTransaction(db, async (transaction) => {
                        const sfDoc = await transaction.get(userDocRef);
                        const currentBestScore = sfDoc.exists() ? sfDoc.data().score : 0;
                        if (newScore > currentBestScore) {
                            transaction.set(userDocRef, { score: newScore, date: new Date().toISOString() });
                            setHighScore(newScore);
                        }
                    });
                } catch (error) { console.error(error); }
            }, [db, userId, appId]);

            return { userId, isAuthReady, isLoading, highScore, saveHighScore };
        };

        const ImportModal = ({ isOpen, onClose, handleFileChange, statusMessage, resetQuizToDefault }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                        <h3 className="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">üì• T·∫£i C√¢u H·ªèi</h3>
                        <div className="space-y-4">
                            <input type="file" accept=".json" onChange={handleFileChange} className="text-sm w-full" />
                            <p className="text-xs text-gray-500">{statusMessage}</p>
                            <button onClick={resetQuizToDefault} className="w-full py-2 text-sm text-indigo-700 border border-indigo-300 rounded-lg">üîÅ M·∫∑c ƒë·ªãnh</button>
                            <button onClick={onClose} className="w-full py-2 bg-indigo-600 text-white rounded-lg">ƒê√≥ng</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const { userId, isLoading, highScore, saveHighScore } = useGoJaScoreAndAuth();
            const [questions, setQuestions] = useState(QUIZ_DATA); 
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [currentScore, setCurrentScore] = useState(0);
            const [isAnswered, setIsAnswered] = useState(false);
            const [feedback, setFeedback] = useState('');
            const [isQuizFinished, setIsQuizFinished] = useState(false);
            const [statusMessage, setStatusMessage] = useState('ƒêang d√πng m·∫∑c ƒë·ªãnh.');
            const [isModalOpen, setIsModalOpen] = useState(false);

            const resetQuiz = useCallback((newQuestions = questions) => {
                setQuestions(newQuestions);
                setCurrentQuestionIndex(0);
                setCurrentScore(0);
                setIsAnswered(false);
                setFeedback('');
                setIsQuizFinished(false);
            }, [questions]);

            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data)) {
                            resetQuiz(data);
                            setStatusMessage(`‚úÖ Th√†nh c√¥ng!`);
                            setTimeout(() => setIsModalOpen(false), 500);
                        }
                    } catch (e) { setStatusMessage("‚ùå L·ªói JSON"); }
                };
                reader.readAsText(file);
            };

            const currentQuestion = questions[currentQuestionIndex];
            const checkAnswer = (option) => {
                if (isAnswered) return;
                const correct = option === currentQuestion.answer;
                setIsAnswered(true);
                if (correct) {
                    setFeedback('‚úÖ Ch√≠nh x√°c!');
                    setCurrentScore(s => s + 1);
                } else setFeedback(`‚ùå Sai r·ªìi! ƒê√°p √°n: ${currentQuestion.answer}`);
            };

            const handleNext = () => {
                if (currentQuestionIndex < questions.length - 1) {
                    setCurrentQuestionIndex(i => i + 1);
                    setIsAnswered(false);
                    setFeedback('');
                } else {
                    setIsQuizFinished(true);
                    saveHighScore(currentScore);
                }
            };

            return (
                <div className="min-h-screen p-4 flex flex-col items-center justify-center">
                    <div className="w-full max-w-sm bg-white p-6 rounded-2xl shadow-xl border border-indigo-100">
                        
                        {/* HEADER: Ch·ªØ GoJa ƒë√£ th√†nh link nh·∫•n ƒë∆∞·ª£c */}
                        <div className="flex justify-between items-center mb-6 border-b-2 border-indigo-200 pb-2">
                            <a href="index.html" className="text-3xl font-extrabold text-indigo-700 hover:opacity-70 transition-opacity">
                                <span role="img" aria-label="japan flag">üáØüáµ</span> GoJa
                            </a>
                            <button onClick={() => setIsModalOpen(true)} className="p-2 bg-teal-600 text-white rounded-full shadow-md text-lg">üì•</button>
                        </div>
                        
                        <div className="flex justify-between text-sm font-semibold text-gray-600 mb-4 p-3 bg-gray-100 rounded-lg">
                            <p>ƒêi·ªÉm: <span className="text-indigo-600">{currentScore}</span></p>
                            <p>Cao nh·∫•t: <span className="text-green-600">{highScore}</span></p>
                        </div>
                        
                        {isQuizFinished ? (
                            <div className="text-center space-y-4">
                                <h3 className="text-xl font-bold">HO√ÄN TH√ÄNH!</h3>
                                <p className="text-3xl font-bold text-green-600">{currentScore} / {questions.length}</p>
                                <button onClick={() => resetQuiz()} className="w-full py-3 bg-indigo-600 text-white rounded-xl shadow-lg">Ch∆°i L·∫°i</button>
                            </div>
                        ) : (
                            <div className="space-y-6">
                                <p className="text-sm text-gray-400">C√¢u: {currentQuestionIndex + 1}/{questions.length}</p>
                                <div className="p-4 bg-indigo-50 rounded-xl text-center">
                                    <p className="text-3xl font-black text-indigo-800">{currentQuestion.word}</p>
                                </div>
                                <div className="space-y-3">
                                    {currentQuestion.options.map((opt, i) => (
                                        <button key={i} onClick={() => checkAnswer(opt)} disabled={isAnswered}
                                            className={`w-full py-3 rounded-xl text-white font-medium transition-all ${isAnswered ? (opt === currentQuestion.answer ? 'bg-green-500' : 'bg-gray-400') : 'bg-teal-600 hover:bg-teal-700'}`}>
                                            {opt}
                                        </button>
                                    ))}
                                </div>
                                {isAnswered && (
                                    <div className="space-y-4">
                                        <p className={`text-center font-bold ${feedback.includes('‚úÖ') ? 'text-green-600' : 'text-red-600'}`}>{feedback}</p>
                                        <button onClick={handleNext} className="w-full py-3 bg-indigo-500 text-white rounded-xl shadow-lg">
                                            {currentQuestionIndex < questions.length - 1 ? 'Ti·∫øp theo ‚û°Ô∏è' : 'K·∫øt th√∫c üèÅ'}
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* N√öT QUAY V·ªÄ: N·∫±m g·ªçn g√†ng b√™n trong khung tr·∫Øng */}
                        <div className="mt-8 pt-4 border-t border-gray-100 text-center">
                            <a href="index.html" className="inline-flex items-center text-sm font-bold text-indigo-400 hover:text-indigo-600 transition-colors">
                                <span className="mr-2">‚¨ÖÔ∏è</span> Quay v·ªÅ m√†n h√¨nh ch√≠nh
                            </a>
                        </div>

                        <div className="mt-4 text-[10px] text-gray-300 text-center uppercase tracking-widest">
                            ID: {userId || 'Authenticating...'}
                        </div>
                    </div>

                    <ImportModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} handleFileChange={handleFileChange} statusMessage={statusMessage} resetQuizToDefault={() => resetQuiz(QUIZ_DATA)} />
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
