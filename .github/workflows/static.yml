<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoJa - ·ª®ng D·ª•ng T·ª´ V·ª±ng Ti·∫øng Nh·∫≠t</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i React v√† ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- T·∫£i Babel ƒë·ªÉ x·ª≠ l√Ω JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-indigo-50 font-sans">
    <!-- N∆°i React s·∫Ω render ·ª©ng d·ª•ng -->
    <div id="root"></div>

    <!-- T·∫£i c√°c th∆∞ vi·ªán Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // G√°n c√°c h√†m Firebase v√†o window ƒë·ªÉ code React (Babel) c√≥ th·ªÉ truy c·∫≠p
        window.firebaseAppModules = {
            initializeApp, getAuth, signInWithCustomToken, signInAnonymously,
            getFirestore, doc, getDoc, runTransaction, setLogLevel
        };
        // B·∫≠t log Firebase ·ªü ch·∫ø ƒë·ªô Debug
        setLogLevel('Debug');
    </script>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        const { 
            initializeApp, getAuth, signInWithCustomToken, signInAnonymously, 
            getFirestore, doc, getDoc, runTransaction 
        } = window.firebaseAppModules;

        // D·ªØ li·ªáu c√¢u h·ªèi N4/N3 m·∫∑c ƒë·ªãnh
        const QUIZ_DATA = [
            { word: "ÊôØËâ≤ („Åë„Åó„Åç)", options: ["Th·ªùi ti·∫øt", "C·∫£nh s·∫Øc", "L·ªãch s·ª≠", "√Çm nh·∫°c"], answer: "C·∫£nh s·∫Øc" },
            { word: "ÂÖ•Èô¢„Åô„Çã („Å´„ÇÖ„ÅÜ„ÅÑ„Çì„Åô„Çã)", options: ["T·ªët nghi·ªáp", "Nh·∫≠p vi·ªán", "Xu·∫•t c·∫£nh", "V√†o c√¥ng ty"], answer: "Nh·∫≠p vi·ªán" },
            { word: "Âç±„Å™„ÅÑ („ÅÇ„Å∂„Å™„ÅÑ)", options: ["Nhanh ch√≥ng", "Nguy hi·ªÉm", "D·ªÖ d√†ng", "Quan tr·ªçng"], answer: "Nguy hi·ªÉm" },
            { word: "Â∞ÜÊù• („Åó„Çá„ÅÜ„Çâ„ÅÑ)", options: ["Qu√° kh·ª©", "Hi·ªán t·∫°i", "T∆∞∆°ng lai", "B√¢y gi·ªù"], answer: "T∆∞∆°ng lai" },
            { word: "‰∫§ÈÄö („Åì„ÅÜ„Å§„ÅÜ)", options: ["C√¥ng vi·ªác", "Giao th√¥ng", "Th·ªùi ti·∫øt", "S·ª©c kh·ªèe"], answer: "Giao th√¥ng" },
            { word: "ÁµåÈ®ì („Åë„ÅÑ„Åë„Çì)", options: ["L√Ω thuy·∫øt", "Ki·∫øn th·ª©c", "Kinh nghi·ªám", "H·ªçc v·∫•n"], answer: "Kinh nghi·ªám" }
        ];

        // --- CUSTOM HOOK: Qu·∫£n l√Ω Auth v√† ƒêi·ªÉm Cao (Gi·∫£i quy·∫øt Point 3) ---
        const useGoJaScoreAndAuth = () => {
            const [db, setDb] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [highScore, setHighScore] = useState(0);
            const [isLoading, setIsLoading] = useState(true);
            const appId = useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'goja-app', []);

            // Logic 1: Kh·ªüi t·∫°o v√† X√°c th·ª±c
            useEffect(() => {
                const authenticateAndInit = async () => {
                    try {
                        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                        if (!Object.keys(firebaseConfig).length) throw new Error("Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh Firebase.");

                        const app = initializeApp(firebaseConfig);
                        const authInstance = getAuth(app);
                        const dbInstance = getFirestore(app);

                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(authInstance, __initial_auth_token);
                        } else {
                            await signInAnonymously(authInstance);
                        }
                        
                        const currentUserId = authInstance.currentUser?.uid || crypto.randomUUID();
                        setUserId(currentUserId);
                        setDb(dbInstance);
                        setIsAuthReady(true);
                    } catch (error) {
                        console.error("L·ªói x√°c th·ª±c/kh·ªüi t·∫°o Firebase:", error.message);
                        setIsAuthReady(true); 
                    } finally {
                        setIsLoading(false);
                    }
                };
                authenticateAndInit();
            }, []);

            // Logic 2: T·∫£i ƒêi·ªÉm Cao
            const loadHighScore = useCallback(async () => {
                if (!db || !userId) return;
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/scores`, 'goja_high_score');
                try {
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        setHighScore(docSnap.data().score);
                    }
                } catch (error) {
                    console.error("L·ªói khi t·∫£i ƒëi·ªÉm cao:", error);
                }
            }, [db, userId, appId]);

            useEffect(() => {
                if (isAuthReady && userId && db) {
                    loadHighScore();
                }
            }, [isAuthReady, userId, db, loadHighScore]);

            // Logic 3: L∆∞u ƒêi·ªÉm Cao
            const saveHighScore = useCallback(async (newScore) => {
                if (!db || !userId) return;

                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/scores`, 'goja_high_score');
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const sfDoc = await transaction.get(userDocRef);
                        const currentBestScore = sfDoc.exists() ? sfDoc.data().score : 0;
                        
                        if (newScore > currentBestScore) {
                            transaction.set(userDocRef, { score: newScore, date: new Date().toISOString() });
                            setHighScore(newScore);
                        }
                    });
                } catch (error) {
                    console.error("L·ªói khi l∆∞u ƒëi·ªÉm cao:", error);
                }
            }, [db, userId, appId]);

            return { userId, isAuthReady, isLoading, highScore, saveHighScore };
        };

        // Component Modal T·∫£i B·ªô C√¢u H·ªèi
        const ImportModal = ({ isOpen, onClose, handleFileChange, statusMessage, resetQuizToDefault }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform scale-100 transition-transform duration-300">
                        <h3 className="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">
                            üì• T·∫£i B·ªô C√¢u H·ªèi
                        </h3>
                        <p className="text-sm text-gray-600 mb-4">
                            T·∫£i l√™n t·ªáp JSON ch·ª©a b·ªô t·ª´ v·ª±ng c·ªßa ri√™ng b·∫°n (c·∫ßn c√≥ c√°c tr∆∞·ªùng: `word`, `options`, `answer`).
                        </p>
                        
                        <div className="space-y-4">
                            <input 
                                type="file" 
                                accept=".json" 
                                onChange={handleFileChange} 
                                className="text-sm w-full file:mr-4 file:py-2 file:px-3 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-teal-100 file:text-teal-700 hover:file:bg-teal-200 cursor-pointer"
                            />

                            <p className={`text-sm ${statusMessage.startsWith('‚úÖ') ? 'text-green-600' : statusMessage.startsWith('‚ùå') ? 'text-red-600' : 'text-gray-500'}`}>
                                {statusMessage}
                            </p>

                            <button
                                onClick={resetQuizToDefault}
                                className="w-full py-2 text-sm text-indigo-700 border border-indigo-300 rounded-lg hover:bg-indigo-50 transition duration-150 active:scale-[0.99]"
                            >
                                üîÅ D√πng B·ªô C√¢u H·ªèi M·∫∑c ƒê·ªãnh
                            </button>

                            <button
                                onClick={onClose}
                                className="w-full py-2 bg-indigo-600 text-white rounded-lg shadow-sm hover:bg-indigo-700 transition duration-150 active:scale-95"
                            >
                                ƒê√≥ng
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Component ch√≠nh c·ªßa ·ª©ng d·ª•ng
        const App = () => {
            // S·ª≠ d·ª•ng Custom Hook ƒë·ªÉ l·∫•y tr·∫°ng th√°i Auth/ƒêi·ªÉm cao (Code s·∫°ch h∆°n)
            const { userId, isLoading, highScore, saveHighScore } = useGoJaScoreAndAuth();
            
            // --- GAME STATES ---
            const [questions, setQuestions] = useState(QUIZ_DATA); 
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [currentScore, setCurrentScore] = useState(0);
            const [isAnswered, setIsAnswered] = useState(false);
            const [feedback, setFeedback] = useState('');
            const [isQuizFinished, setIsQuizFinished] = useState(false);
            const [statusMessage, setStatusMessage] = useState('ƒêang d√πng b·ªô c√¢u h·ªèi m·∫∑c ƒë·ªãnh.');
            const [isModalOpen, setIsModalOpen] = useState(false);

            // --- H√ÄM RESET QUIZ (Gi·∫£i quy·∫øt Point 1) ---
            const resetQuiz = useCallback((newQuestions = questions) => {
                setQuestions(newQuestions);
                setCurrentQuestionIndex(0);
                setCurrentScore(0);
                setIsAnswered(false);
                setFeedback('');
                setIsQuizFinished(false);
            }, [questions]);

            const resetQuizToDefault = () => {
                resetQuiz(QUIZ_DATA);
                setStatusMessage(`ƒê√£ ƒë·∫∑t l·∫°i th√†nh c√¥ng b·ªô c√¢u h·ªèi m·∫∑c ƒë·ªãnh (${QUIZ_DATA.length} c√¢u)!`);
            };

            // --- LOGIC T·∫¢I FILE D·ªÆ LI·ªÜU ---
            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        // Ki·ªÉm tra c·∫•u tr√∫c ƒë∆°n gi·∫£n c·ªßa JSON
                        if (Array.isArray(data) && data.length > 0 && data.every(item => item.word && Array.isArray(item.options) && item.answer)) {
                            resetQuiz(data); // C·∫≠p nh·∫≠t b·ªô c√¢u h·ªèi v√† reset tr√≤ ch∆°i
                            setStatusMessage(`‚úÖ ƒê√£ t·∫£i th√†nh c√¥ng ${data.length} c√¢u h·ªèi m·ªõi t·ª´ t·ªáp!`);
                            // ƒê√≥ng modal sau khi t·∫£i th√†nh c√¥ng
                            setTimeout(() => setIsModalOpen(false), 500); 
                        } else {
                            setStatusMessage("‚ùå L·ªói: ƒê·ªãnh d·∫°ng t·ªáp JSON kh√¥ng h·ª£p l·ªá.");
                        }
                    } catch (error) {
                        setStatusMessage("‚ùå L·ªói ƒë·ªçc t·ªáp. H√£y ƒë·∫£m b·∫£o ƒë√≥ l√† t·ªáp JSON h·ª£p l·ªá.");
                        console.error("File read error:", error);
                    }
                };
                reader.readAsText(file);
            };

            // --- LOGIC TR√í CH∆†I ---
            const currentQuestion = questions[currentQuestionIndex];
            const totalQuestions = questions.length;

            const checkAnswer = (selectedOption) => {
                if (isAnswered) return;

                const isCorrect = selectedOption === currentQuestion.answer;
                setIsAnswered(true);

                if (isCorrect) {
                    setFeedback('‚úÖ Ch√≠nh x√°c! +1 ƒëi·ªÉm.');
                    setCurrentScore(prevScore => prevScore + 1);
                } else {
                    setFeedback(`‚ùå Sai r·ªìi. ƒê√°p √°n ƒë√∫ng l√†: ${currentQuestion.answer}`);
                }
            };

            const handleNext = () => {
                if (currentQuestionIndex < totalQuestions - 1) {
                    setCurrentQuestionIndex(prevIndex => prevIndex + 1);
                    setIsAnswered(false);
                    setFeedback('');
                } else {
                    // K·∫øt th√∫c b√†i ki·ªÉm tra
                    setIsQuizFinished(true);
                    saveHighScore(currentScore);
                }
            };

            const handleRestart = () => {
                resetQuiz(questions);
            };

            // Logic ch·ªçn class cho n√∫t (Gi·∫£i quy·∫øt Point 2 - styling)
            const getButtonClass = (option) => {
                const baseClasses = 'w-full py-3 text-white font-medium rounded-xl transition-all duration-200 shadow-md active:scale-[0.98]';
                
                if (!isAnswered) {
                    // Tr·∫°ng th√°i ch∆∞a tr·∫£ l·ªùi
                    return `${baseClasses} bg-teal-600 hover:bg-teal-700`;
                }
                
                // Tr·∫°ng th√°i ƒë√£ tr·∫£ l·ªùi
                if (option === currentQuestion.answer) {
                    // ƒê√°p √°n ƒë√∫ng
                    return `${baseClasses} bg-green-500 shadow-lg`;
                }
                
                if (option !== currentQuestion.answer) {
                    // ƒê√°p √°n sai
                    return `${baseClasses} bg-gray-400 opacity-80 shadow-inner`;
                }
            };
            
            // --- RENDER FUNCTIONS ---
            
            if (isLoading) {
                return (
                    <div className="flex items-center justify-center h-screen bg-indigo-50">
                        <div className="text-xl text-indigo-800 animate-pulse">ƒêang t·∫£i ·ª©ng d·ª•ng GoJa...</div>
                    </div>
                );
            }

            const renderQuizContent = () => {
                if (isQuizFinished) {
                    return (
                        <div className="p-4 space-y-4">
                            <h3 className="text-2xl font-extrabold text-indigo-700">üèÜ HO√ÄN TH√ÄNH B√ÄI KI·ªÇM TRA!</h3>
                            <p className="text-lg text-gray-700">
                                B·∫°n ƒë√£ ƒë·∫°t ƒë∆∞·ª£c: <span className="text-3xl font-bold text-green-600">{currentScore}</span> / {totalQuestions} ƒëi·ªÉm.
                            </p>
                            <p className="text-md text-gray-600">
                                ƒêi·ªÉm cao nh·∫•t c·ªßa b·∫°n: <span className="font-bold text-indigo-500">{highScore}</span>
                            </p>
                            {currentScore > highScore && highScore > 0 && (
                                <p className="text-yellow-600 font-semibold">üéâ K·ª∑ l·ª•c m·ªõi ƒë√£ ƒë∆∞·ª£c l∆∞u!</p>
                            )}
                            <button
                                onClick={handleRestart}
                                className="w-full py-3 mt-6 text-white bg-indigo-600 rounded-lg shadow-lg hover:bg-indigo-700 transition duration-150 active:scale-95"
                            >
                                Ch∆°i L·∫°i ({totalQuestions} c√¢u)
                            </button>
                        </div>
                    );
                }

                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center text-gray-500 font-semibold text-sm">
                            <span>C√¢u: {currentQuestionIndex + 1} / {totalQuestions}</span>
                        </div>
                        
                        <div id="question" className="p-4 bg-indigo-50 rounded-xl shadow-inner min-h-[100px] flex items-center justify-center border-b-4 border-indigo-200">
                            <p className="text-3xl sm:text-4xl font-black text-indigo-800 break-words">{currentQuestion.word}</p>
                        </div>

                        <div className="options space-y-3" id="options-container">
                            {currentQuestion.options.map((option, index) => (
                                <button
                                    key={index}
                                    onClick={() => checkAnswer(option)}
                                    className={getButtonClass(option)}
                                    disabled={isAnswered}
                                >
                                    {option}
                                </button>
                            ))}
                        </div>

                        <div id="feedback" className={`min-h-[30px] font-semibold text-center transition-opacity duration-300 ${isAnswered ? 'opacity-100' : 'opacity-0'} ${feedback.startsWith('‚úÖ') ? 'text-green-600' : 'text-red-600'}`}>
                            {feedback}
                        </div>

                        {isAnswered && (
                            <button
                                onClick={handleNext}
                                className="w-full py-3 text-white bg-indigo-500 rounded-xl shadow-lg hover:bg-indigo-600 transition duration-150 active:scale-95"
                            >
                                {currentQuestionIndex < totalQuestions - 1 ? 'C√¢u Ti·∫øp Theo ‚û°Ô∏è' : 'K·∫øt Th√∫c B√†i Thi üèÅ'}
                            </button>
                        )}
                    </div>
                );
            };

            return (
                <div className="min-h-screen p-4 sm:p-6 flex items-center justify-center">
                    <div className="w-full max-w-sm bg-white p-6 sm:p-8 rounded-2xl shadow-xl border border-indigo-100">
                        
                        <div className="flex justify-between items-center mb-6 border-b-2 border-indigo-200 pb-2">
                            <h1 className="text-3xl font-extrabold text-indigo-700">
                                <span role="img" aria-label="japan flag">üáØüáµ</span> GoJa
                            </h1>
                            <button 
                                onClick={() => setIsModalOpen(true)}
                                className="p-2 bg-teal-600 text-white rounded-full shadow-md hover:bg-teal-700 transition-transform active:scale-95 text-lg"
                                title="T·∫£i B·ªô C√¢u H·ªèi"
                            >
                                üì•
                            </button>
                        </div>
                        
                        <div className="flex justify-between text-sm sm:text-base font-semibold text-gray-600 mb-4 p-3 bg-gray-100 rounded-lg shadow-inner">
                            <p>
                                ƒêi·ªÉm Hi·ªán T·∫°i: <span className="text-indigo-600 font-bold">{currentScore}</span>
                            </p>
                            <p>
                                ƒêi·ªÉm Cao Nh·∫•t: <span className="text-green-600 font-bold">{highScore}</span>
                            </p>
                        </div>
                        
                        {renderQuizContent()}

                        <div className="mt-6 text-xs text-gray-400 text-center border-t pt-3">
                            ID Ng∆∞·ªùi D√πng: {userId || 'ƒêang x√°c th·ª±c...'}
                        </div>
                    </div>

                    <ImportModal 
                        isOpen={isModalOpen} 
                        onClose={() => setIsModalOpen(false)} 
                        handleFileChange={handleFileChange} 
                        statusMessage={statusMessage} 
                        resetQuizToDefault={resetQuizToDefault}
                    />
                </div>
            );
        };

        // Render ·ª©ng d·ª•ng
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>


